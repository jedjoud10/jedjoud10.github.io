<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="light dark" name=color-scheme><title>Ray-Marching and Temporal Depth Reprojection</title><link href=/img/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/img/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/img/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=https://fonts.googleapis.com rel=preconnect><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,600;1,600&family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Prompt:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Roboto+Mono:ital,wght@0,500;1,500&family=Sankofa+Display&display=swap" rel=stylesheet><style>body{--primary-color:#5871a2;--primary-pale-color:#5871a210;--text-color:#3c4043;--text-pale-color:#94969f;--bg-color:#fff;--highlight-mark-color:#5f75b035;--callout-note-color:#5871a2;--callout-important-color:#8062b0;--callout-warning-color:#936e51;--callout-alert-color:#bc5252;--callout-question-color:#477389;--callout-tip-color:#3c8460;--main-font:"Roboto Mono",ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--code-font:"Roboto Mono",ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--homepage-max-width:768px;--main-max-width:768px;--avatar-size:60px;--icon-size:20px;--homepage-font-size:16px;--homepage-line-height:1.5;--paragraph-font-size:16px;--paragraph-line-height:1.5;--aside-font-size:15px;--img-border-radius:0;--callout-border-radius:0;--detail-border-radius:0;--dark-mode-img-brightness:1.0;--dark-mode-chart-brightness:1.0;--inline-code-border-radius:2px;--inline-code-bg-color:var(--primary-pale-color);--block-code-border-radius:0;--code-font-size:14px;--block-code-border-color:var(--primary-color);--detail-border-color:var(--primary-color)}body.dark{--primary-color:#ce79d6;--primary-pale-color:#8d5dac20;--text-color:#9197a5;--text-pale-color:#747983;--bg-color:#232529;--highlight-mark-color:#5f75b035;--callout-note-color:#ba70d8;--callout-important-color:#9571cf;--callout-warning-color:#babb69;--callout-alert-color:#f36060;--callout-question-color:#477389;--callout-tip-color:#3c8460}</style><link href=/main.css rel=stylesheet><link href=/hl-light.css id=hl rel=stylesheet><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV rel=stylesheet><script crossorigin defer integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js></script><script crossorigin defer integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:'$$',right:'$$',display:true},{left:'$',right:'$',display:false},{left:'\\(',right:'\\)',display:false},{left:'\\[',right:'\\]',display:true}],throwOnError:false})})</script><body class=post><script>const theme=sessionStorage.getItem('theme');const match=window.matchMedia("(prefers-color-scheme: dark)").matches;if(theme&&theme=='dark'||!theme&&match){document.body.classList.add('dark');const a=document.querySelector('link#hl');if(a)a.href='/hl-dark.css'}</script><header class=blur><div id=header-wrapper><nav><a class=instant href=/>Jed037</a><button aria-label="toggle expand" class=separator id=toggler>::</button><span class="wrap left fold">{</span><a class="instant fold" href=/projects>projects</a><span class="wrap-separator fold">,</span><a class="instant fold" href=/about>about</a><span class="wrap right fold">} ;</span></nav><div id=btns><button aria-label="theme switch" data-moon-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill="currentColor"></path></svg>' data-sun-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M12 18C8.68629 18 6 15.3137 6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12C18 15.3137 15.3137 18 12 18ZM12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM11 1H13V4H11V1ZM11 20H13V23H11V20ZM3.51472 4.92893L4.92893 3.51472L7.05025 5.63604L5.63604 7.05025L3.51472 4.92893ZM16.9497 18.364L18.364 16.9497L20.4853 19.0711L19.0711 20.4853L16.9497 18.364ZM19.0711 3.51472L20.4853 4.92893L18.364 7.05025L16.9497 5.63604L19.0711 3.51472ZM5.63604 16.9497L7.05025 18.364L4.92893 20.4853L3.51472 19.0711L5.63604 16.9497ZM23 11V13H20V11H23ZM4 11V13H1V11H4Z" fill="currentColor"></path></svg>' id=theme-toggle><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill=currentColor></path></svg></button><button aria-label="table of content" id=toc-toggle><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M3 4H21V6H3V4ZM3 11H15V13H3V11ZM3 18H21V20H3V18Z" fill=currentColor></path></svg></button></div></div></header><div id=wrapper><div id=blank></div><aside><nav><ul><li><a class=h2 href=#yapping>Yapping</a><li><a class=h2 href=#why-i-thought-reprojection-would-work>Why I thought reprojection would work</a><li><a class=h2 href=#rotational-reprojection>Rotational Reprojection</a><li><a class=h2 href=#positional-reprojection>Positional Reprojection</a><li><a class=h2 href=#actual-code-used>Actual code used</a><li><a class=h2 href=#conclusion-and-results>Conclusion and results</a></ul></nav><button aria-label="back to top" id=back-to-top><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M11.9997 10.8284L7.04996 15.7782L5.63574 14.364L11.9997 8L18.3637 14.364L16.9495 15.7782L11.9997 10.8284Z" fill=currentColor></path></svg></button></aside><main><div><div data-check-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M10.0007 15.1709L19.1931 5.97852L20.6073 7.39273L10.0007 17.9993L3.63672 11.6354L5.05093 10.2212L10.0007 15.1709Z" fill="currentColor"></path></svg>' data-copy-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill="currentColor"></path></svg>' id=copy-cfg style=display:none></div><article data-backlink-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M9.41421 8L18.0208 16.6066L16.6066 18.0208L8 9.41421V17H6V6H17V8H9.41421Z" fill="currentColor"></path></svg>' class=prose><h1>Ray-Marching and Temporal Depth Reprojection</h1><div id=post-info><div id=date><span id=publish>2024-05-21</span></div><div id=tags><a class=instant href=https://jedjoud10.github.io/tags/c><span>#</span>c#</a><a class=instant href=https://jedjoud10.github.io/tags/opentk><span>#</span>openTK</a><a class=instant href=https://jedjoud10.github.io/tags/opengl><span>#</span>openGL</a><a class=instant href=https://jedjoud10.github.io/tags/glsl><span>#</span>glsl</a><a class=instant href=https://jedjoud10.github.io/tags/graphics-dev><span>#</span>graphics-dev</a></div></div><h1 id=yapping>Yapping<a aria-label="Anchor link for: yapping" class=zola-anchor href=#yapping style=visibility:hidden>#</a></h1><p>In this short blog post, I will show you how I managed to use reprojected last frame depth information as an optimization for my C#/OpenGL voxel ray-marcher. So, for the past few months, I've been working on this super tiny voxel raymarcher written in OpenGL and OpenTK. I finally decided to give in into the hype train after being convinced after watching custom voxel engine stuff on youtube (GabeRundlett, Ratty, Douglas, xima).<p>The main reason why I wanted to implement my own ray marcher was to implement this idea I've had for a wihle to use depth data from previous frames as an acceleration structure, which, as you read in the name of the blog post, deemed to be sufficient and robust enough. Ok enough yapping time to show how this shit worked<h1 id=why-i-thought-reprojection-would-work><em>Why</em> I thought reprojection would work<a aria-label="Anchor link for: why-i-thought-reprojection-would-work" class=zola-anchor href=#why-i-thought-reprojection-would-work style=visibility:hidden>#</a></h1><p>In my head, I <strong>knew</strong> reprojection could be used to make ray-marching a lot quicker, since you could use the depth information from last frame and use <em>that</em> as a starting point for your starting position. Basically allows you to skip over all the early iterations since you know they won't hit anything.<blockquote class="callout note"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM11 7H13V9H11V7ZM11 11H13V17H11V11Z" fill=currentColor></path></svg></div><div class=content><p><strong>Note</strong><p>Now unfortunately this would only work for a static scene (or a scene where the depth of a pixel doesn't change over frames without any camera movement). For example, imagine a pixel having a depth $d$ at frame $t$. This ray-"advancing" optimization would only work if $d_{t-1}>d_{t}$, since the pre-advanced ray would clip into the volume instead.<p>Even with a small offset that you subtract from the approximated depth, you'd still run into issues if the depth changes without any camera movement (like modifying the geometry at runtime)</div></blockquote><p>I really <em>really</em> wanted to implement this since no-one else seems to have implemented it and I couldn't find anything about it online. This would also help me get my toes wet with reproj stuff in general since that's been a long standing goal of mine when it comes to shader stuff.<p>This is how I decided to implement it: split the reprojection stuff into two parts:<ol><li>One part to handle rotational reprojection, since depth would not change over frames and since movement seems a bit too complex for me to handle directly.<li>Positional reprojection that takes account the new position of the camera. I originally feared that I'd need to do something like iterate within my reprojection step after I viewed this example of <a href="https://youtu.be/VvFyOFacljg?t=70" rel="nofollow noreferrer">VR reprojection</a> (which is what I had to do eventually :( )</ol><p>I started planning stuff out on paper thinking how this reprojection stuff based on the overly simplistic definition given by one of the members of a discord server I was in.<p>"nodle man" is me btw. Immense thanks to <code>misha</code> and <code>rwighter</code> in that server btw. Thankies for helpies :3 <img alt src=/reprojection.png><h1 id=rotational-reprojection>Rotational Reprojection<a aria-label="Anchor link for: rotational-reprojection" class=zola-anchor href=#rotational-reprojection style=visibility:hidden>#</a></h1><p>Ok, so I tried implemented what <code>misha</code> suggested. Seems pretty simple right? I could even simplify doing reprojection of the position by just reprojection the pixel ray <em>direction</em> instead, since that wouldn't change based on position but solely rotation!!! I am a genius!!!!<p>Unfortunately, this is where the majority of my problems began. Now, these problems weren't because I couldn't implement reprojection, but because my original ray-marching code (that I tested multiple times to make sure worked fine without repro) was flawed from the start. My math was wrong all along, and I was actually projecting <em>by</em> the viewproj matrix to calculate direction, which is absolutely <strong>fucking</strong> wrong!!!<p>What you actually need to do is take the inverse of the matrix and do vertex projection steps (like in a simple rasterized shader) but in the opposite order. I was very dumb and I spent like a solid 5 hours trying to figure out why my repro code didn't work ('cause in of itself it doesn't use that "inverted" viewproj matrix).<p>Anyways, after losing my mind over that problem I finally got some rotation reprojection working. Actually was a pretty robust solution and it worked nicely. There is the major flaw that this only worked with rotational reprojection, so any linear movement caused some rays to completely miss their targets, but for the intended purpose it worked really good.<h1 id=positional-reprojection>Positional Reprojection<a aria-label="Anchor link for: positional-reprojection" class=zola-anchor href=#positional-reprojection style=visibility:hidden>#</a></h1><p>Now is time for the relatively hard part; positional reprojection. I had absolutely no idea how to do this because it isn't as straight forward as you think. When the camera moves from last frame's position to the current frame's position, there are multiple factors that could change how the scene depth changes during this translation.<p>If, for example, the camera moved forward in the direction it is currently looking at, the depth would decrease by a very slight amount that is proportional to the speed of the camera at that moment. This only holds true for the pixel at the very center of the screen (where uv = (0,0) if in range of [-1, 1]). For any other pixel the deph change is slightly less since we're using perspective projection and stuff.<p>As I had no idea what I was fucking doing, I looked up videos and other resources about this type of reprojeciton stuff, which led me to <a rel="nofollow noreferrer" href=https://en.wikipedia.org/wiki/Asynchronous_reprojection>Asynchronous Reprojection</a> for VR and this <a href="https://youtu.be/VvFyOFacljg?t=70" rel="nofollow noreferrer">demo view</a> implementing such a reprojection technique within the Unity game engine. As the wiki states, this technique is used in VR for cases where the hardware can't keep up with the software and causes the fps to drop, which is a very bad experience in VR, so this technique kinda uses the data from last frame and new rotation information from the headset to reproject the viewed image. This is basically what I want to do, but instead of reprojecting the whole image directly I would just repro the depth data to use in the current frame.<blockquote class="callout note"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM11 7H13V9H11V7ZM11 11H13V17H11V11Z" fill=currentColor></path></svg></div><div class=content><p><strong>Note</strong><p>You could probably implement the async reprojection stuff on <strong>top</strong> of the current one to possibly speed it up even more, but at a latency cost kinda.</div></blockquote><p>I decided to draw all of this on a piece of paper first to see how I would check the closest distance to the scene even after a "local" translation and rotation. This drawing just showcases two camera frustum, slightly offset from each other in one case and slightly rotated from each other in another case to see how I should remap the voxel geometry simply based on these differences. This actually helped me find out a flaw with my reprojection code which caused me some headaches cause I forgot to keep the ray direction un-normalized after I project it using the perspective matrix.<p><em>temporarily removed as I'm remaking it to make it clearer. Handwriting fucking sucks.</em><p>Now, by the look of the demo video, it looked like some sort of iterative approach was at work because of the clear stepping that occured when the camera goes "inside" the old frustum and looking at it from the side. I kinda knew that it was doing something like ray-marching the old frustum itself, so that's what I tried to do first, and surprisingly that was literally how you implement positional reprojection (albeit probably the most naive method todo so)<h1 id=actual-code-used>Actual code used<a aria-label="Anchor link for: actual-code-used" class=zola-anchor href=#actual-code-used style=visibility:hidden>#</a></h1><p>If you want to see the actual code behind this reprojection stuff here it is: Okay-ish code that will calculate ray-direction based on uv space. Literally just boilerplate for any raymarching / raytracing stuff really. Do note that we must keep a ray direction vector <strong><strong>NOT NORMALIZED</strong></strong>. Very important<pre class="language-glsl z-code" data-lang=glsl><code class=language-glsl data-lang=glsl><span class="z-source z-glsl"><span class="z-comment z-line z-double-slash z-glsl"><span class="z-punctuation z-definition z-comment z-glsl">//</span> apply projection transformations for ray 
</span><span class="z-storage z-type z-glsl">vec4</span> ray_dir_non_normalized <span class="z-keyword z-operator z-assignment z-glsl">=</span> <span class="z-meta z-function-call z-glsl"><span class="z-variable z-function z-glsl">inverse</span><span class="z-meta z-group z-glsl"><span class="z-punctuation z-section z-group z-begin z-glsl">(</span></span></span><span class="z-meta z-function-call z-glsl"><span class="z-meta z-group z-glsl">proj_matrix</span></span><span class="z-meta z-function-call z-glsl"><span class="z-meta z-group z-glsl"><span class="z-punctuation z-section z-group z-end z-glsl">)</span></span></span> <span class="z-keyword z-operator z-glsl">*</span> <span class="z-storage z-type z-glsl">vec4</span><span class="z-meta z-group z-glsl"><span class="z-punctuation z-section z-group z-begin z-glsl">(</span>coords<span class="z-punctuation z-separator z-glsl">,</span> <span class="z-keyword z-operator z-arithmetic z-glsl">-</span><span class="z-constant z-numeric z-glsl">1.0</span><span class="z-punctuation z-separator z-glsl">,</span> <span class="z-constant z-numeric z-glsl">1.0</span><span class="z-punctuation z-section z-group z-end z-glsl">)</span></span><span class="z-punctuation z-terminator z-glsl">;</span>
ray_dir_non_normalized<span class="z-punctuation z-accessor z-glsl">.</span><span class="z-variable z-other z-member z-glsl">w</span> <span class="z-keyword z-operator z-assignment z-glsl">=</span> <span class="z-constant z-numeric z-glsl">0.0</span><span class="z-punctuation z-terminator z-glsl">;</span>
ray_dir_non_normalized <span class="z-keyword z-operator z-assignment z-glsl">=</span> <span class="z-meta z-function-call z-glsl"><span class="z-variable z-function z-glsl">inverse</span><span class="z-meta z-group z-glsl"><span class="z-punctuation z-section z-group z-begin z-glsl">(</span></span></span><span class="z-meta z-function-call z-glsl"><span class="z-meta z-group z-glsl">view_matrix</span></span><span class="z-meta z-function-call z-glsl"><span class="z-meta z-group z-glsl"><span class="z-punctuation z-section z-group z-end z-glsl">)</span></span></span> <span class="z-keyword z-operator z-glsl">*</span> ray_dir_non_normalized<span class="z-punctuation z-terminator z-glsl">;</span>
<span class="z-storage z-type z-glsl">vec3</span> ray_dir <span class="z-keyword z-operator z-assignment z-glsl">=</span> <span class="z-meta z-function-call z-glsl"><span class="z-support z-function z-glsl">normalize</span><span class="z-meta z-group z-glsl"><span class="z-punctuation z-section z-group z-begin z-glsl">(</span></span></span><span class="z-meta z-function-call z-glsl"><span class="z-meta z-group z-glsl">ray_dir_non_normalized<span class="z-punctuation z-accessor z-glsl">.</span><span class="z-variable z-other z-member z-glsl">xyz</span></span></span><span class="z-meta z-function-call z-glsl"><span class="z-meta z-group z-glsl"><span class="z-punctuation z-section z-group z-end z-glsl">)</span></span></span><span class="z-punctuation z-terminator z-glsl">;</span>
<span class="z-storage z-type z-glsl">vec3</span> inv_dir <span class="z-keyword z-operator z-assignment z-glsl">=</span> <span class="z-constant z-numeric z-glsl">1.0</span> <span class="z-keyword z-operator z-arithmetic z-glsl">/</span> <span class="z-meta z-group z-glsl"><span class="z-punctuation z-section z-group z-begin z-glsl">(</span>ray_dir <span class="z-keyword z-operator z-arithmetic z-glsl">+</span> <span class="z-storage z-type z-glsl">vec3</span><span class="z-meta z-group z-glsl"><span class="z-punctuation z-section z-group z-begin z-glsl">(</span><span class="z-constant z-numeric z-glsl">0.0001</span><span class="z-punctuation z-section z-group z-end z-glsl">)</span></span><span class="z-punctuation z-section z-group z-end z-glsl">)</span></span><span class="z-punctuation z-terminator z-glsl">;</span>
</span></code></pre><p>Hideous code that actually handles calculating the uvs of the current pixel (more specifically pixel dir) in last frame uv-space This was the code that specifically handled rotational reprojection in cases where the camera does not<pre class="language-glsl z-code" data-lang=glsl><code class=language-glsl data-lang=glsl><span class="z-source z-glsl"><span class="z-storage z-type z-glsl">vec4</span> last_uvs_full <span class="z-keyword z-operator z-assignment z-glsl">=</span> <span class="z-meta z-group z-glsl"><span class="z-punctuation z-section z-group z-begin z-glsl">(</span>proj_matrix <span class="z-keyword z-operator z-glsl">*</span> last_frame_view_matrix<span class="z-punctuation z-section z-group z-end z-glsl">)</span></span> <span class="z-keyword z-operator z-glsl">*</span> <span class="z-storage z-type z-glsl">vec4</span><span class="z-meta z-group z-glsl"><span class="z-punctuation z-section z-group z-begin z-glsl">(</span>ray_dir_non_normalized<span class="z-punctuation z-accessor z-glsl">.</span><span class="z-variable z-other z-member z-glsl">xyz</span><span class="z-punctuation z-separator z-glsl">,</span> <span class="z-constant z-numeric z-glsl">0.0</span><span class="z-punctuation z-section z-group z-end z-glsl">)</span></span><span class="z-punctuation z-terminator z-glsl">;</span>

<span class="z-comment z-line z-double-slash z-glsl"><span class="z-punctuation z-definition z-comment z-glsl">//</span> the thing that I forgot that kinda made me insane
</span>last_uvs_full<span class="z-punctuation z-accessor z-glsl">.</span><span class="z-variable z-other z-member z-glsl">xyz</span> <span class="z-keyword z-operator z-assignment z-augmented z-glsl">/=</span> last_uvs_full<span class="z-punctuation z-accessor z-glsl">.</span><span class="z-variable z-other z-member z-glsl">w</span><span class="z-punctuation z-terminator z-glsl">;</span>

<span class="z-comment z-line z-double-slash z-glsl"><span class="z-punctuation z-definition z-comment z-glsl">//</span> convert the [-1,1] range to [0,1] for texture sampling
</span><span class="z-storage z-type z-glsl">vec2</span> last_uvs <span class="z-keyword z-operator z-assignment z-glsl">=</span> last_uvs_full<span class="z-punctuation z-accessor z-glsl">.</span><span class="z-variable z-other z-member z-glsl">xy</span><span class="z-punctuation z-terminator z-glsl">;</span>
last_uvs <span class="z-keyword z-operator z-assignment z-augmented z-glsl">+=</span> <span class="z-constant z-numeric z-glsl">1</span><span class="z-punctuation z-terminator z-glsl">;</span>
last_uvs <span class="z-keyword z-operator z-assignment z-augmented z-glsl">/=</span> <span class="z-constant z-numeric z-glsl">2</span><span class="z-punctuation z-terminator z-glsl">;</span>
</span></code></pre><p>Positional reprojection loop. Basically ray-marching within the ray-marched depth of the previous / still frame so we can keep a safe "minimum" distance to the scene even if we move any direction. Do note that before I fetch the depth texture of the last frame, I run a little downsampling / dilation step that simply blurs the depth texture and takes the smallest value in the convolution grid (which saves me to handle this in the main loop below). I think you could even run the whole reprojection step at a lower resolution since the results are going to be dilated by some small amount anyways<pre class="language-glsl z-code" data-lang=glsl><code class=language-glsl data-lang=glsl><span class="z-source z-glsl"><span class="z-keyword z-control z-glsl">for</span> <span class="z-meta z-group z-glsl"><span class="z-punctuation z-section z-group z-begin z-glsl">(</span><span class="z-storage z-type z-glsl">int</span> i <span class="z-keyword z-operator z-assignment z-glsl">=</span> <span class="z-constant z-numeric z-glsl">0</span><span class="z-punctuation z-terminator z-glsl">;</span> i <span class="z-keyword z-operator z-comparison z-glsl"><</span> total_steps<span class="z-punctuation z-terminator z-glsl">;</span> i<span class="z-keyword z-operator z-arithmetic z-glsl">+</span><span class="z-keyword z-operator z-arithmetic z-glsl">+</span><span class="z-punctuation z-section z-group z-end z-glsl">)</span></span> <span class="z-meta z-block z-glsl"><span class="z-punctuation z-section z-block z-begin z-glsl">{</span>
  <span class="z-storage z-type z-glsl">vec3</span> temp_ray_dir <span class="z-keyword z-operator z-assignment z-glsl">=</span> repr_pos <span class="z-keyword z-operator z-arithmetic z-glsl">-</span> last_position<span class="z-punctuation z-terminator z-glsl">;</span>
  <span class="z-storage z-type z-glsl">vec4</span> test_uvs <span class="z-keyword z-operator z-assignment z-glsl">=</span> <span class="z-meta z-group z-glsl"><span class="z-punctuation z-section z-group z-begin z-glsl">(</span>proj_matrix <span class="z-keyword z-operator z-glsl">*</span> last_frame_view_matrix<span class="z-punctuation z-section z-group z-end z-glsl">)</span></span> <span class="z-keyword z-operator z-glsl">*</span> <span class="z-storage z-type z-glsl">vec4</span><span class="z-meta z-group z-glsl"><span class="z-punctuation z-section z-group z-begin z-glsl">(</span>temp_ray_dir<span class="z-punctuation z-separator z-glsl">,</span> <span class="z-constant z-numeric z-glsl">0.0</span><span class="z-punctuation z-section z-group z-end z-glsl">)</span></span><span class="z-punctuation z-terminator z-glsl">;</span>
  
  <span class="z-comment z-line z-double-slash z-glsl"><span class="z-punctuation z-definition z-comment z-glsl">//</span> the thing that I forot that kinda made me insane
</span>  test_uvs<span class="z-punctuation z-accessor z-glsl">.</span><span class="z-variable z-other z-member z-glsl">xyz</span> <span class="z-keyword z-operator z-assignment z-augmented z-glsl">/=</span> test_uvs<span class="z-punctuation z-accessor z-glsl">.</span><span class="z-variable z-other z-member z-glsl">w</span><span class="z-punctuation z-terminator z-glsl">;</span>
  <span class="z-storage z-type z-glsl">vec2</span> test_uvs2 <span class="z-keyword z-operator z-assignment z-glsl">=</span> test_uvs<span class="z-punctuation z-accessor z-glsl">.</span><span class="z-variable z-other z-member z-glsl">xy</span><span class="z-punctuation z-terminator z-glsl">;</span>

  <span class="z-comment z-line z-double-slash z-glsl"><span class="z-punctuation z-definition z-comment z-glsl">//</span> convert the [-1,1] range to [0,1] for texture sampling
</span>  test_uvs2 <span class="z-keyword z-operator z-assignment z-augmented z-glsl">+=</span> <span class="z-constant z-numeric z-glsl">1</span><span class="z-punctuation z-terminator z-glsl">;</span>
  test_uvs2 <span class="z-keyword z-operator z-assignment z-augmented z-glsl">/=</span> <span class="z-constant z-numeric z-glsl">2</span><span class="z-punctuation z-terminator z-glsl">;</span>

  <span class="z-comment z-line z-double-slash z-glsl"><span class="z-punctuation z-definition z-comment z-glsl">//</span> check if the iterated position is within the old frustum
</span>  <span class="z-keyword z-control z-glsl">if</span> <span class="z-meta z-group z-glsl"><span class="z-punctuation z-section z-group z-begin z-glsl">(</span>test_uvs2<span class="z-punctuation z-accessor z-glsl">.</span><span class="z-variable z-other z-member z-glsl">x</span> <span class="z-keyword z-operator z-comparison z-glsl">></span> <span class="z-constant z-numeric z-glsl">0</span> <span class="z-keyword z-operator z-arithmetic z-glsl">&&</span> test_uvs2<span class="z-punctuation z-accessor z-glsl">.</span><span class="z-variable z-other z-member z-glsl">y</span> <span class="z-keyword z-operator z-comparison z-glsl">></span> <span class="z-constant z-numeric z-glsl">0</span> <span class="z-keyword z-operator z-arithmetic z-glsl">&&</span> test_uvs2<span class="z-punctuation z-accessor z-glsl">.</span><span class="z-variable z-other z-member z-glsl">x</span> <span class="z-keyword z-operator z-comparison z-glsl"><</span> <span class="z-constant z-numeric z-glsl">1</span> <span class="z-keyword z-operator z-arithmetic z-glsl">&&</span> test_uvs2<span class="z-punctuation z-accessor z-glsl">.</span><span class="z-variable z-other z-member z-glsl">y</span> <span class="z-keyword z-operator z-comparison z-glsl"><</span> <span class="z-constant z-numeric z-glsl">1</span> <span class="z-keyword z-operator z-arithmetic z-glsl">&&</span> test_uvs<span class="z-punctuation z-accessor z-glsl">.</span><span class="z-variable z-other z-member z-glsl">w</span> <span class="z-keyword z-operator z-comparison z-glsl">></span> <span class="z-constant z-numeric z-glsl">0</span><span class="z-punctuation z-section z-group z-end z-glsl">)</span></span> <span class="z-meta z-block z-glsl"><span class="z-punctuation z-section z-block z-begin z-glsl">{</span>
    <span class="z-storage z-type z-glsl">float</span> od <span class="z-keyword z-operator z-assignment z-glsl">=</span> <span class="z-meta z-function-call z-glsl"><span class="z-support z-function z-glsl">texture</span><span class="z-meta z-group z-glsl"><span class="z-punctuation z-section z-group z-begin z-glsl">(</span></span></span><span class="z-meta z-function-call z-glsl"><span class="z-meta z-group z-glsl">last_temporal_depth<span class="z-punctuation z-separator z-glsl">,</span> test_uvs2 <span class="z-keyword z-operator z-arithmetic z-glsl">/</span> scale_factor</span></span><span class="z-meta z-function-call z-glsl"><span class="z-meta z-group z-glsl"><span class="z-punctuation z-section z-group z-end z-glsl">)</span></span></span><span class="z-punctuation z-accessor z-glsl">.</span><span class="z-variable z-other z-member z-glsl">x</span><span class="z-punctuation z-terminator z-glsl">;</span>
    <span class="z-storage z-type z-glsl">float</span> nd <span class="z-keyword z-operator z-assignment z-glsl">=</span> <span class="z-meta z-function-call z-glsl"><span class="z-support z-function z-glsl">distance</span><span class="z-meta z-group z-glsl"><span class="z-punctuation z-section z-group z-begin z-glsl">(</span></span></span><span class="z-meta z-function-call z-glsl"><span class="z-meta z-group z-glsl">last_position<span class="z-punctuation z-separator z-glsl">,</span> repr_pos</span></span><span class="z-meta z-function-call z-glsl"><span class="z-meta z-group z-glsl"><span class="z-punctuation z-section z-group z-end z-glsl">)</span></span></span><span class="z-punctuation z-terminator z-glsl">;</span>

    <span class="z-comment z-line z-double-slash z-glsl"><span class="z-punctuation z-definition z-comment z-glsl">//</span> checking depth values
</span>    <span class="z-keyword z-control z-glsl">if</span> <span class="z-meta z-group z-glsl"><span class="z-punctuation z-section z-group z-begin z-glsl">(</span>od <span class="z-keyword z-operator z-comparison z-glsl"><</span> nd<span class="z-punctuation z-section z-group z-end z-glsl">)</span></span> <span class="z-meta z-block z-glsl"><span class="z-punctuation z-section z-block z-begin z-glsl">{</span>
      pos_reprojected_depth <span class="z-keyword z-operator z-assignment z-glsl">=</span> <span class="z-meta z-function-call z-glsl"><span class="z-support z-function z-glsl">distance</span><span class="z-meta z-group z-glsl"><span class="z-punctuation z-section z-group z-begin z-glsl">(</span></span></span><span class="z-meta z-function-call z-glsl"><span class="z-meta z-group z-glsl">position<span class="z-punctuation z-separator z-glsl">,</span> repr_pos</span></span><span class="z-meta z-function-call z-glsl"><span class="z-meta z-group z-glsl"><span class="z-punctuation z-section z-group z-end z-glsl">)</span></span></span> <span class="z-keyword z-operator z-arithmetic z-glsl">-</span> step_size <span class="z-keyword z-operator z-glsl">*</span> step_size_offset_factor<span class="z-punctuation z-terminator z-glsl">;</span>
      total_repro_steps_percent_taken <span class="z-keyword z-operator z-assignment z-glsl">=</span> <span class="z-storage z-type z-glsl">float</span><span class="z-meta z-group z-glsl"><span class="z-punctuation z-section z-group z-begin z-glsl">(</span>i<span class="z-punctuation z-section z-group z-end z-glsl">)</span></span> <span class="z-keyword z-operator z-arithmetic z-glsl">/</span> <span class="z-storage z-type z-glsl">float</span><span class="z-meta z-group z-glsl"><span class="z-punctuation z-section z-group z-begin z-glsl">(</span>total_steps<span class="z-punctuation z-section z-group z-end z-glsl">)</span></span><span class="z-punctuation z-terminator z-glsl">;</span>
      <span class="z-keyword z-control z-glsl">break</span><span class="z-punctuation z-terminator z-glsl">;</span>
    <span class="z-punctuation z-section z-block z-end z-glsl">}</span></span>
  <span class="z-punctuation z-section z-block z-end z-glsl">}</span></span>

  repr_pos <span class="z-keyword z-operator z-assignment z-augmented z-glsl">+=</span> ray_dir <span class="z-keyword z-operator z-glsl">*</span> step_size<span class="z-punctuation z-terminator z-glsl">;</span>
<span class="z-punctuation z-section z-block z-end z-glsl">}</span></span>
</span></code></pre><h1 id=conclusion-and-results>Conclusion and results<a aria-label="Anchor link for: conclusion-and-results" class=zola-anchor href=#conclusion-and-results style=visibility:hidden>#</a></h1><p>This optimization worked pretty nicely for most cases. There's definitely a big big room for improvement because I feel like the positional repro loop could be simplified using some sort of heuristic. Something like a HiZ depth pyramid could help us skip early steps. And for the rotational repo variant, it's really fast, but really really buggy whenever you move. You can make it swap between rotational / positional reprojection based on camera movement, but it would be a bit erratic for the framerate to increase whenever you are not moving out of nowhere.<blockquote class="callout note"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM11 7H13V9H11V7ZM11 11H13V17H11V11Z" fill=currentColor></path></svg></div><div class=content><p><strong>Idea</strong><p>If we treat each pixel on the screen as a mini frustum (with specific near/far bounds based on the last depth texture), we could do something like a line-frustum check to check the closest depth distance to scene that we can safely march by. Basically getting rid of the whole inner frustum ray-marching step for the positional reprojector. No idea if this idea would work but would be interesting to experiment with this.</div></blockquote><blockquote class="callout note"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM11 7H13V9H11V7ZM11 11H13V17H11V11Z" fill=currentColor></path></svg></div><div class=content><p><strong>Another Idea</strong><p>You could probably use subgroup operations and atomic operations to avoid marching through a lot in the volume by assuming that the minimum depth within a subgroup is close to the depth of each invocation / fragment within that subgroup. Cause if this is the case, then you could either do something like frustum/cone-marching instead of ray-marching for a coarse approximation and then do a finer <em>ray</em>-marched second step to get closer to the actual scene depth for each pixel in the subgroup.</div></blockquote></article><div class=giscus></div></div><footer><div class=copyright><p>Jed037</div><div class=credits>powered by <a rel="noreferrer noopener" href=https://www.getzola.org target=_blank>zola</a> and <a rel="noreferrer noopener" href=https://github.com/isunjn/serene target=_blank>serene</a></div></footer></main></div><script src=/js/lightense.min.js></script><script type=module>
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script><script src=/js/main.js></script>